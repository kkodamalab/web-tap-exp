<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Online Tapping Experiment (BHK Demo)</title>
<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  margin: 40px;
}
button {
  font-size: 16px;
  padding: 10px 20px;
  margin: 5px;
}
textarea {
  width: 90%;
  height: 150px;
  margin-top: 15px;
}
#counter {
  font-size: 24px;
  margin: 20px;
}
</style>
</head>
<body>

<h2>Online Tapping Experiment</h2>

<label>
  <input type="radio" name="mode" value="self" checked>
  Self-paced
</label>

<label>
  <input type="radio" name="mode" value="metro">
  Metronome
</label>

<br><br>

<label>
  Metronome Hz:
  <input type="number" id="hzInput" value="2.0" min="0.5" max="4" step="0.5">
</label>

<br><br>

<button onclick="startTask()">Start</button>
<button onclick="resetTask()">Reset</button>

<div id="counter">Press Start</div>

<textarea id="output" placeholder="ITI (ms) will appear here..."></textarea><br>

<button onclick="copyData()">Copy ITI</button>
<button onclick="downloadCSV()">Download CSV</button>

<script>
let times = [];
let lastTime = null;
let tapCount = 0;
let maxTap = 70;
let metroInterval = null;
let audioCtx = null;
let currentCondition = "";

function startTask() {
  times = [];
  tapCount = 0;
  lastTime = null;
  document.getElementById("output").value = "";
  document.getElementById("counter").innerText = "Tap SPACE key";

  if (getMode() === "metro") {
    let hz = parseFloat(document.getElementById("hzInput").value);

    if (isNaN(hz) || hz < 0.5 || hz > 4) {
      alert("Hz must be between 0.5 and 4.");
      return;
    }

    let interval = 1000 / hz;

    currentCondition = "Metronome-" + hz + "Hz";

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    metroInterval = setInterval(beep, interval);

  } else {
    currentCondition = "Self-paced";
  }
}

function resetTask() {
  times = [];
  tapCount = 0;
  lastTime = null;
  clearInterval(metroInterval);
  document.getElementById("counter").innerText = "Reset";
  document.getElementById("output").value = "";
}

function getMode() {
  return document.querySelector('input[name="mode"]:checked').value;
}

function beep() {
  const osc = audioCtx.createOscillator();
  osc.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.05);
}

document.addEventListener("keydown", function(e) {
  if (e.code !== "Space") return;
  if (tapCount >= maxTap) return;

  const now = performance.now();

  if (lastTime !== null) {
    times.push(now - lastTime);
  }

  lastTime = now;
  tapCount++;

  document.getElementById("counter").innerText =
    "Taps: " + tapCount + " / " + maxTap;

  if (tapCount === maxTap) {
    clearInterval(metroInterval);
    processData();
  }
});

function processData() {
  let trimmed = times.slice(5, 69); // 64ç‚¹

  document.getElementById("output").value =
    trimmed.map(x => x.toFixed(3)).join("\n");

  document.getElementById("counter").innerText =
    "Finished (64 ITIs ready)";
}

function copyData() {
  const text = document.getElementById("output").value;
  navigator.clipboard.writeText(text);
  alert("Copied!");
}

function downloadCSV() {
  let trimmed = times.slice(5, 69);

  let csvContent = "Condition," + currentCondition + "\n";
  csvContent += "ITI_ms\n";
  trimmed.forEach(val => {
    csvContent += val.toFixed(3) + "\n";
  });

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);

  const now = new Date();
  const timestamp =
    now.getFullYear().toString() +
    String(now.getMonth()+1).padStart(2,'0') +
    String(now.getDate()).padStart(2,'0') + "_" +
    String(now.getHours()).padStart(2,'0') +
    String(now.getMinutes()).padStart(2,'0') +
    String(now.getSeconds()).padStart(2,'0');

  const filename = currentCondition + "_" + timestamp + ".csv";

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();

  window.URL.revokeObjectURL(url);
}
</script>

</body>
</html>
